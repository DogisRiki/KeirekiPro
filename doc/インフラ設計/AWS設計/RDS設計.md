# RDS設計書

## 1. インスタンス設計

### 1.1 基本設定

| 項目 | 設定値 |
|------|--------|
| エンジン | PostgreSQL |
| エンジンバージョン | 17.7 |
| インスタンス識別子 | keirekipro-db |
| インスタンスクラス | db.t4g.micro |
| マルチAZ配置 | 無効 |
| デプロイオプション | シングルインスタンス |

### 1.2 ストレージ設定

| 項目 | 設定値 |
|------|--------|
| ストレージタイプ | gp3 |
| 割り当てストレージ | 20 GB |
| 最大ストレージ | 20 GB |
| ストレージの自動スケーリング | 無効 |
| プロビジョンドIOPS | 3,000（gp3デフォルト） |
| スループット | 125 MiB/s（gp3デフォルト） |

### 1.3 接続設定

| 項目 | 設定値 |
|------|--------|
| VPC | keirekipro-vpc |
| サブネットグループ | keirekipro-db-subnet-group |
| パブリックアクセス | 無効 |
| セキュリティグループ | keirekipro-rds-sg |
| ポート | 5432 |

## 2. サブネットグループ設計

| 項目 | 設定値 |
|------|--------|
| 名前 | keirekipro-db-subnet-group |
| 説明 | Subnet group for KeirekiPro RDS |
| VPC | keirekipro-vpc |
| サブネット | keirekipro-private-1a, keirekipro-private-1c |

## 3. パラメータグループ設計

| 項目 | 設定値 |
|------|--------|
| パラメータグループ名 | keirekipro-db-params |
| ファミリー | postgres17 |

### 3.1 カスタムパラメータ

| パラメータ名 | 設定値 | 説明 |
|-------------|--------|------|
| timezone | Asia/Tokyo | データベースのタイムゾーン。日本時間でタイムスタンプを扱う |
| log_statement | none | 実行されたSQL文のログ出力設定。本番環境ではセキュリティとパフォーマンスの観点から無効化 |
| log_min_duration_statement | 1000 | 指定ミリ秒以上かかったクエリをログ出力。1秒以上のスロークエリを記録しパフォーマンス問題の調査に使用 |

## 4. 認証設定

| 項目 | 設定値 |
|------|--------|
| マスターユーザー名 | keirekipro_master |
| マスターパスワード | Terraformの`random_password`で生成（32文字、特殊文字なし） |
| IAMデータベース認証 | 無効 |

## 5. バックアップ設定

| 項目 | 設定値 |
|------|--------|
| 自動バックアップ | 有効 |
| バックアップ保持期間 | 7日 |
| バックアップウィンドウ | 18:00-19:00 UTC（JST 03:00-04:00） |
| スナップショットのコピータグ | 有効 |

## 6. メンテナンス設定

| 項目 | 設定値 |
|------|--------|
| 自動マイナーバージョンアップグレード | 有効 |
| メンテナンスウィンドウ | Sun:19:00-Sun:20:00 UTC（JST 月04:00-05:00） |

## 7. モニタリング設定

| 項目 | 設定値 |
|------|--------|
| 拡張モニタリング | 無効 |
| Performance Insights | 無効 |
| CloudWatch Logsエクスポート | 無効 |

## 8. 暗号化設定

| 項目 | 設定値 |
|------|--------|
| 保管時の暗号化 | 有効 |
| KMSキー | AWS管理キー（aws/rds） |

## 9. 削除保護設定

| 項目 | 設定値 |
|------|--------|
| 削除保護 | 有効 |
| 最終スナップショット | 有効 |
| 最終スナップショット識別子 | keirekipro-db-final-snapshot |

※ 削除保護を有効にすることで、Terraformやマネジメントコンソールからの誤操作によるRDSインスタンスの削除を防止する。削除する場合は、先に削除保護を無効化する手順が必要となる。

## 10. 初期データベース設計

| 項目 | 設定値 |
|------|--------|
| 初期データベース名 | keireki_pro |
| 文字セット | UTF8 |
| 照合順序 | en_US.UTF-8 |

## 11. ユーザー設計

### 11.1 マスターユーザー（アプリケーションでも使用）

| 項目 | 設定値 |
|------|--------|
| ユーザー名 | keirekipro_master |
| パスワード管理 | Terraformの`random_password`で生成 |
| パスワード保管 | Secrets Manager（keirekipro/rds） |
| 用途 | データベース管理作業、アプリケーションからの接続 |

※ ポートフォリオ用途のため、運用簡素化を優先しマスターユーザーをアプリケーションからも使用する。本番運用では最小権限の原則に従いアプリケーション専用ユーザーを作成することを推奨。

### 11.2 テーブル構築・マスタデータ挿入

| 項目 | 設定値 |
|------|--------|
| マイグレーションツール | Flyway |
| 実行タイミング | アプリケーション起動時 |
| マイグレーションファイル配置 | src/main/resources/db/migration/ |
| 実行ユーザー | keirekipro_master |

## 12. Secrets Manager連携

### 12.1 シークレット設計

| シークレット名 | 用途 | 管理方法 |
|---------------|------|---------|
| keirekipro/rds | アプリケーションからのDB接続情報 | Terraformで作成・値設定 |
