# ALB設計書

## 1. ALB基本設定

| 項目 | 設定値 |
|------|--------|
| 名前 | keirekipro-alb |
| スキーム | internet-facing |
| IPアドレスタイプ | IPv4 |
| VPC | keirekipro-vpc |
| サブネット | keirekipro-public-1a, keirekipro-public-1c |
| セキュリティグループ | keirekipro-alb-sg |
| アイドルタイムアウト | 60秒 |
| 削除保護 | 有効 |
| HTTP/2 | 有効 |
| クロスゾーン負荷分散 | 有効 |

## 2. リスナー設計

### 2.1 HTTPSリスナー

| 項目 | 設定値 |
|------|--------|
| プロトコル | HTTPS |
| ポート | 443 |
| デフォルトSSL証明書 | ACM証明書（api.keirekipro.click用・ap-northeast-1発行） |
| 追加SSL証明書 | ACM証明書（app.keirekipro.click用・ap-northeast-1発行） |
| SSLポリシー | ELBSecurityPolicy-TLS13-1-2-2021-06 |
| デフォルトアクション | 固定レスポンス（403） |

## 3. ターゲットグループ設計

### 3.1 基本設定

| 項目 | 設定値 |
|------|--------|
| ターゲットグループ名 | keirekipro-backend-tg |
| ターゲットタイプ | IP |
| プロトコル | HTTP |
| ポート | 8080 |
| VPC | keirekipro-vpc |
| プロトコルバージョン | HTTP/1.1 |

### 3.2 ヘルスチェック設定

| 項目 | 設定値 |
|------|--------|
| ヘルスチェックプロトコル | HTTP |
| ヘルスチェックパス | /actuator/health |
| ヘルスチェックポート | traffic-port |
| 正常のしきい値 | 2回 |
| 非正常のしきい値 | 3回 |
| タイムアウト | 5秒 |
| 間隔 | 30秒 |
| 成功コード | 200 |

### 3.3 ターゲット属性

| 項目 | 設定値 |
|------|--------|
| 登録解除の遅延 | 30秒 |
| スロースタート期間 | 0秒 |
| ロードバランシングアルゴリズム | ラウンドロビン |
| スティッキーセッション | 無効 |

## 4. リスナールール設計

### 4.1 ルール一覧

| 優先度 | 条件 | アクション |
|--------|------|-----------|
| 1 | HTTPヘッダー: X-Origin-Verify = {シークレット値} かつ パスパターン: /api/* | ターゲットグループへ転送 |
| デフォルト | （上記以外すべて） | 固定レスポンス: 403 Forbidden |

### 4.2 ルール詳細: X-Origin-Verify検証ルール（優先度1）

条件:

| 条件タイプ | 設定値 |
|-----------|--------|
| HTTPヘッダー | X-Origin-Verify = {Secrets Managerから取得した値} |
| パスパターン | /api/* |

アクション:

| アクション | 設定値 |
|-----------|--------|
| タイプ | ターゲットグループへ転送 |
| ターゲットグループ | keirekipro-backend-tg |

### 4.3 デフォルトルール

アクション:

| アクション | 設定値 |
|-----------|--------|
| タイプ | 固定レスポンスを返す |
| レスポンスコード | 403 |
| コンテンツタイプ | text/plain |
| レスポンス本文 | Forbidden |

## 5. SSL証明書設計

### 5.1 証明書一覧

| 証明書 | ドメイン名 | 用途 | 設定方法 |
|--------|-----------|------|---------|
| デフォルト証明書 | api.keirekipro.click | CloudFrontからのAPI通信 | リスナーのcertificate_arn |
| 追加証明書 | app.keirekipro.click | 直接アクセス時（拒否用） | aws_lb_listener_certificate |

※ CloudFrontはオリジンとしてapi.keirekipro.clickを使用するため、APIサブドメイン用の証明書をデフォルトとして設定する。

## 6. アクセスログ設定

| 項目 | 設定値 |
|------|--------|
| アクセスログ | 有効 |
| S3バケット | keirekipro-alb-logs |
| プレフィックス | alb |
| ログ間隔 | 5分 |

## 7. X-Origin-Verifyヘッダー運用

### 7.1 シークレット管理

| 項目 | 設定値 |
|------|--------|
| シークレット名 | keirekipro/alb-origin-verify |
| 保管場所 | AWS Secrets Manager |
| 値の形式 | ランダム文字列（64文字以上） |

### 7.2 設定箇所

| コンポーネント | 設定内容 |
|---------------|---------|
| CloudFront | オリジンへのリクエストにX-Origin-Verifyヘッダーを付与 |
| ALBリスナールール | X-Origin-Verifyヘッダーの値を検証 |

## 8. 接続ドレイン設定

| 項目 | 設定値 |
|------|--------|
| 登録解除の遅延 | 30秒 |
