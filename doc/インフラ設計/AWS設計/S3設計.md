# S3設計書

## 1. バケット一覧

| バケット名 | 用途 | アクセス方式 |
|-----------|------|-------------|
| keirekipro-frontend | フロントエンドビルド成果物（React） | CloudFront経由（OAC） |
| keirekipro-storage | ユーザーアップロード画像（プロフィール画像） | CloudFront経由（OAC）+ Pre-signed URL |
| keirekipro-alb-logs | ALBアクセスログ | AWSサービス直接書き込み |

## 2. フロントエンド用バケット（keirekipro-frontend）

### 2.1 基本設定

| 項目 | 設定値 |
|------|--------|
| バケット名 | keirekipro-frontend |
| リージョン | ap-northeast-1 |
| バージョニング | 無効 |
| オブジェクトロック | 無効 |
| 静的ウェブサイトホスティング | 無効 |

### 2.2 パブリックアクセス設定

| 項目 | 設定値 |
|------|--------|
| パブリックアクセスをすべてブロック | 有効 |
| 新しいACLによるパブリックアクセスをブロック | 有効 |
| 任意のACLによるパブリックアクセスをブロック | 有効 |
| 新しいバケットポリシーによるパブリックアクセスをブロック | 有効 |
| 任意のバケットポリシーによるパブリックアクセスをブロック | 有効 |

### 2.3 暗号化設定

| 項目 | 設定値 |
|------|--------|
| サーバー側の暗号化 | 有効 |
| 暗号化タイプ | SSE-S3（AES-256） |
| バケットキー | 有効 |

### 2.4 バケットポリシー（OAC用）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudFrontOAC",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudfront.amazonaws.com"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::keirekipro-frontend/*",
      "Condition": {
        "StringEquals": {
          "AWS:SourceArn": "arn:aws:cloudfront::${AWS_ACCOUNT_ID}:distribution/${DISTRIBUTION_ID}"
        }
      }
    }
  ]
}
```

### 2.5 オブジェクト構成

| パス | 内容 |
|------|------|
| /index.html | SPAエントリーポイント |
| /assets/* | JavaScript、CSS、フォント等 |
| /favicon.ico | ファビコン |

### 2.6 ライフサイクルルール

| ルール名 | 対象 | アクション |
|---------|------|-----------|
| なし | - | ライフサイクルルールは設定しない |

## 3. 画像用バケット（keirekipro-storage）

### 3.1 基本設定

| 項目 | 設定値 |
|------|--------|
| バケット名 | keirekipro-storage |
| リージョン | ap-northeast-1 |
| バージョニング | 無効 |
| オブジェクトロック | 無効 |
| 静的ウェブサイトホスティング | 無効 |

### 3.2 パブリックアクセス設定

| 項目 | 設定値 |
|------|--------|
| パブリックアクセスをすべてブロック | 有効 |
| 新しいACLによるパブリックアクセスをブロック | 有効 |
| 任意のACLによるパブリックアクセスをブロック | 有効 |
| 新しいバケットポリシーによるパブリックアクセスをブロック | 有効 |
| 任意のバケットポリシーによるパブリックアクセスをブロック | 有効 |

### 3.3 暗号化設定

| 項目 | 設定値 |
|------|--------|
| サーバー側の暗号化 | 有効 |
| 暗号化タイプ | SSE-S3（AES-256） |
| バケットキー | 有効 |

### 3.4 バケットポリシー

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudFrontOAC",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudfront.amazonaws.com"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::keirekipro-storage/*",
      "Condition": {
        "StringEquals": {
          "AWS:SourceArn": "arn:aws:cloudfront::${AWS_ACCOUNT_ID}:distribution/${DISTRIBUTION_ID}"
        }
      }
    },
    {
      "Sid": "AllowECSTaskAccess",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::${AWS_ACCOUNT_ID}:role/keirekipro-ecs-task-role"
      },
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject"
      ],
      "Resource": "arn:aws:s3:::keirekipro-storage/*"
    }
  ]
}
```

### 3.5 CORSルール

```json
[
  {
    "AllowedHeaders": ["*"],
    "AllowedMethods": ["GET", "PUT"],
    "AllowedOrigins": ["https://app.keirekipro.click"],
    "ExposeHeaders": ["ETag"],
    "MaxAgeSeconds": 3600
  }
]
```

**※補足**
将来的にフロントエンドからPre-signed URLを使って直接S3にアップロードする可能性を考慮し、CORSルールを設定する。

### 3.6 オブジェクト構成

| パス | 内容 |
|------|------|
| /profile/image/ | プロフィール画像（ファイル名はアプリケーション設計で定義） |

### 3.7 ライフサイクルルール

| ルール名 | 対象 | アクション |
|---------|------|-----------|
| なし | - | ライフサイクルルールは設定しない |

## 4. ALBログ用バケット（keirekipro-alb-logs）

### 4.1 基本設定

| 項目 | 設定値 |
|------|--------|
| バケット名 | keirekipro-alb-logs |
| リージョン | ap-northeast-1 |
| バージョニング | 無効 |
| オブジェクトロック | 無効 |
| 静的ウェブサイトホスティング | 無効 |

### 4.2 パブリックアクセス設定

| 項目 | 設定値 |
|------|--------|
| パブリックアクセスをすべてブロック | 有効 |
| 新しいACLによるパブリックアクセスをブロック | 有効 |
| 任意のACLによるパブリックアクセスをブロック | 有効 |
| 新しいバケットポリシーによるパブリックアクセスをブロック | 有効 |
| 任意のバケットポリシーによるパブリックアクセスをブロック | 有効 |

### 4.3 暗号化設定

| 項目 | 設定値 |
|------|--------|
| サーバー側の暗号化 | 有効 |
| 暗号化タイプ | SSE-S3（AES-256） |
| バケットキー | 有効 |

### 4.4 バケットポリシー（ALBログ用）

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AWSLogDeliveryWrite",
      "Effect": "Allow",
      "Principal": {
        "Service": "delivery.logs.amazonaws.com"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::keirekipro-alb-logs/alb/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-acl": "bucket-owner-full-control",
          "aws:SourceAccount": "${AWS_ACCOUNT_ID}"
        }
      }
    },
    {
      "Sid": "AWSLogDeliveryAclCheck",
      "Effect": "Allow",
      "Principal": {
        "Service": "delivery.logs.amazonaws.com"
      },
      "Action": "s3:GetBucketAcl",
      "Resource": "arn:aws:s3:::keirekipro-alb-logs",
      "Condition": {
        "StringEquals": {
          "aws:SourceAccount": "${AWS_ACCOUNT_ID}"
        }
      }
    }
  ]
}
```

### 4.5 オブジェクト構成

| パス | 内容 |
|------|------|
| /alb/AWSLogs/{account-id}/elasticloadbalancing/{region}/{year}/{month}/{day}/ | ALBアクセスログ（ファイル名はAWSが自動生成） |

### 4.6 ライフサイクルルール

| ルール名 | 対象 | 日数 | アクション |
|---------|------|------|-----------|
| delete-old-logs | alb/* | 30日 | オブジェクトの完全削除 |

## 5. Pre-signed URL設計（画像アップロード用）

### 5.1 Pre-signed URL生成方式

| 項目 | 設定値 |
|------|--------|
| 生成元 | バックエンドアプリケーション |
| 操作タイプ | GetObject（取得用） |
| 有効期限 | 10分 |
| 署名バージョン | Signature Version 4 |

## 6. Terraformバックエンド用バケット（keirekipro-terraform-state）

### 6.1 基本設定

| 項目 | 設定値 |
|------|--------|
| バケット名 | keirekipro-terraform-state |
| リージョン | ap-northeast-1 |
| バージョニング | 有効 |
| オブジェクトロック | 無効 |

### 6.2 パブリックアクセス設定

| 項目 | 設定値 |
|------|--------|
| パブリックアクセスをすべてブロック | 有効 |

### 6.3 暗号化設定

| 項目 | 設定値 |
|------|--------|
| サーバー側の暗号化 | 有効 |
| 暗号化タイプ | SSE-S3（AES-256） |
| バケットキー | 有効 |

### 6.4 バケットポリシー

IAMロール・ポリシー設計書の「keirekipro-terraform-backend-policy」で制御するため、バケットポリシーは設定しない。
