# KeirekiPro インフラ構築 手動作業手順書

本手順書は、Terraform実行前に手動で実施する必要がある作業をまとめたものである。
すべての作業を完了してからTerraformを実行すること。

---

## 目次

1. [事前準備](#1-事前準備)
2. [SES設定（Route 53・ドメイン検証）](#2-ses設定route-53ドメイン検証)
3. [Terraformバックエンド用リソース作成](#3-terraformバックエンド用リソース作成)
4. [GitHub Actions用OIDC設定](#4-github-actions用oidc設定)
5. [Google OAuth認証情報の取得](#5-google-oauth認証情報の取得)
6. [GitHub OAuth認証情報の取得](#6-github-oauth認証情報の取得)
7. [JWT署名鍵の生成](#7-jwt署名鍵の生成)
8. [GitHub Secretsへの機密情報登録](#8-github-secretsへの機密情報登録)
9. [Terraform実行後の作業](#9-terraform実行後の作業)

---

## 1. 事前準備

### 1.1 必要なツールのインストール

以下のツールがインストールされていることを確認する。

```bash
# AWS CLIのバージョン確認
aws --version
# 出力例: aws-cli/2.x.x Python/3.x.x ...

# AWS CLIが未インストールの場合
# macOS
brew install awscli

# Linux
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

# Windows
msiexec.exe /i https://awscli.amazonaws.com/AWSCLIV2.msi
```

### 1.2 AWS CLIの認証設定

```bash
# AWS認証情報の設定
aws configure

# 以下を入力
# AWS Access Key ID: （IAMユーザーのアクセスキー）
# AWS Secret Access Key: （IAMユーザーのシークレットキー）
# Default region name: ap-northeast-1
# Default output format: json

# 設定確認
aws sts get-caller-identity
```

---

## 2. SES設定（Route 53・ドメイン検証）

### 前提条件

- keirekipro.click をNamecheapで購入済み
- AWSアカウントにログイン済み
- リージョン：東京（ap-northeast-1）

### 2.1 Route 53でホストゾーン作成

1. AWSコンソールで「Route 53」を検索して開く
2. 左メニューの「ホストゾーン」をクリック
3. 「ホストゾーンの作成」ボタンをクリック
4. 以下を入力：
   - ドメイン名：`keirekipro.click`
   - タイプ：「パブリックホストゾーン」
   - コメント：`KeirekiPro production domain`
5. 「ホストゾーンの作成」をクリック
6. 作成後、NSレコードに4つのネームサーバーが表示される。これをメモする

### 2.2 Namecheapでネームサーバー変更

1. Namecheapにログイン
2. 「Domain List」→ keirekipro.click の「Manage」をクリック
3. 「Nameservers」セクションを探す
4. 「Namecheap BasicDNS」から「Custom DNS」に変更
5. 2.1でメモした4つのネームサーバーを入力（末尾のドット「.」は不要）
6. 保存
7. 反映まで数分〜最大48時間待つ

#### 確認方法（ターミナルで実行）

```bash
nslookup -type=NS keirekipro.click
```

awsdns のネームサーバーが表示されればOK

### 2.3 SESでドメイン検証（IDの作成）

1. AWSコンソールで「Amazon SES」を検索して開く（リージョン：東京）
2. 左メニューの「設定」→「ID」をクリック
3. 「IDの作成」ボタンをクリック
4. 以下を設定：
   - IDタイプ：「ドメイン」を選択
   - ドメイン：`keirekipro.click` を入力
5. 「詳細設定」を開く
   - 「Easy DKIM」を選択
   - 「DKIM署名キー長」：2048ビット
   - 「Route 53でDKIMレコードを発行」にチェック
6. 「カスタムMAIL FROMドメインの使用」を開く
   - チェックを入れる
   - MAIL FROMドメイン：`mail`（※ `mail.keirekipro.click` ではなく `mail` のみ入力）
   - MX障害時の動作：「デフォルトのMAIL FROMドメインを使用」
   - 「Route 53でMXレコードを発行」にチェック
7. 「IDの作成」をクリック
8. ステータスが「検証済み」になるまで待つ（数分〜数時間）

#### 自動作成されるレコード

以下のレコードはSESがRoute 53に自動作成する：

| レコード名 | タイプ | 用途 |
|-----------|--------|------|
| {selector1}._domainkey.keirekipro.click | CNAME | DKIM |
| {selector2}._domainkey.keirekipro.click | CNAME | DKIM |
| {selector3}._domainkey.keirekipro.click | CNAME | DKIM |
| mail.keirekipro.click | MX | カスタムMAIL FROM |
| mail.keirekipro.click | TXT | MAIL FROM用SPF |

### 2.4 SPFレコード追加（手動）

Route 53に以下のTXTレコードを手動で追加する。

1. Route 53 → ホストゾーン → keirekipro.click を開く
2. 「レコードを作成」をクリック
3. 以下を入力：
   - レコード名：（空欄のまま = keirekipro.click）
   - レコードタイプ：TXT
   - 値：`"v=spf1 include:amazonses.com ~all"`
   - TTL：300
4. 「レコードを作成」をクリック

### 2.5 DMARCレコード追加（手動）

1. 「レコードを作成」をクリック
2. 以下を入力：
   - レコード名：`_dmarc`
   - レコードタイプ：TXT
   - 値：`"v=DMARC1; p=quarantine; rua=mailto:dmarc@keirekipro.click"`
   - TTL：300
3. 「レコードを作成」をクリック

### 2.6 SESでドメイン検証完了を確認

1. SESコンソール → 設定 → ID → keirekipro.click を開く
2. 以下がすべて「検証済み」または「成功」になっていることを確認：
   - IDステータス：検証済み
   - DKIMの設定：成功
   - カスタムMAIL FROMドメイン：成功

### 最終確認：Route 53レコード一覧

設定完了後、以下の9レコードが存在することを確認：

| レコード名 | タイプ | 用途 | 作成方法 |
|-----------|--------|------|----------|
| keirekipro.click | NS | ドメイン委任 | 自動生成 |
| keirekipro.click | SOA | 権威情報 | 自動生成 |
| keirekipro.click | TXT | SPF | 手動 |
| _dmarc.keirekipro.click | TXT | DMARC | 手動 |
| {selector1}._domainkey.keirekipro.click | CNAME | DKIM | SES自動 |
| {selector2}._domainkey.keirekipro.click | CNAME | DKIM | SES自動 |
| {selector3}._domainkey.keirekipro.click | CNAME | DKIM | SES自動 |
| mail.keirekipro.click | MX | カスタムMAIL FROM | SES自動 |
| mail.keirekipro.click | TXT | MAIL FROM用SPF | SES自動 |

### 注意事項

#### MAIL FROMドメイン入力時の注意

SESでカスタムMAIL FROMドメインを設定する際、入力欄には `mail` のみを入力する。`mail.keirekipro.click` とフルで入力すると、レコード名が `mail.keirekipro.click.keirekipro.click` になってしまう。

#### 誤って別リージョンでIDを作成した場合

別リージョン（例：バージニア北部）で誤ってIDを作成し削除した場合、Route 53に作成されたDKIMレコード（CNAMEレコード3個）は自動削除されない。不要なレコードは手動で削除する必要がある。

---

## 3. Terraformバックエンド用リソース作成

TerraformはS3バケットとDynamoDBテーブルを状態管理に使用する。
これらはTerraform自身で作成できないため、事前に手動で作成する。

### 3.1 S3バケットの作成

```bash
# 変数設定
BUCKET_NAME="keirekipro-terraform-state"
REGION="ap-northeast-1"

# S3バケット作成
aws s3api create-bucket \
  --bucket ${BUCKET_NAME} \
  --region ${REGION} \
  --create-bucket-configuration LocationConstraint=${REGION}

# バージョニング有効化
aws s3api put-bucket-versioning \
  --bucket ${BUCKET_NAME} \
  --versioning-configuration Status=Enabled

# サーバーサイド暗号化の設定（SSE-S3）
aws s3api put-bucket-encryption \
  --bucket ${BUCKET_NAME} \
  --server-side-encryption-configuration '{
    "Rules": [
      {
        "ApplyServerSideEncryptionByDefault": {
          "SSEAlgorithm": "AES256"
        },
        "BucketKeyEnabled": true
      }
    ]
  }'

# パブリックアクセスブロック設定
aws s3api put-public-access-block \
  --bucket ${BUCKET_NAME} \
  --public-access-block-configuration '{
    "BlockPublicAcls": true,
    "IgnorePublicAcls": true,
    "BlockPublicPolicy": true,
    "RestrictPublicBuckets": true
  }'

# 作成確認
aws s3api head-bucket --bucket ${BUCKET_NAME}
echo "S3バケット ${BUCKET_NAME} の作成が完了した"
```

### 3.2 DynamoDBテーブルの作成

```bash
# 変数設定
TABLE_NAME="keirekipro-terraform-lock"
REGION="ap-northeast-1"

# DynamoDBテーブル作成
aws dynamodb create-table \
  --table-name ${TABLE_NAME} \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region ${REGION}

# テーブル作成完了を待機
aws dynamodb wait table-exists --table-name ${TABLE_NAME} --region ${REGION}

# 作成確認
aws dynamodb describe-table --table-name ${TABLE_NAME} --region ${REGION} --query 'Table.TableStatus'
echo "DynamoDBテーブル ${TABLE_NAME} の作成が完了した"
```

### 3.3 作成結果の確認

```bash
# S3バケット確認
echo "=== S3バケット ==="
aws s3api get-bucket-versioning --bucket keirekipro-terraform-state
aws s3api get-bucket-encryption --bucket keirekipro-terraform-state

# DynamoDBテーブル確認
echo "=== DynamoDBテーブル ==="
aws dynamodb describe-table --table-name keirekipro-terraform-lock --query 'Table.{Name:TableName,Status:TableStatus,KeySchema:KeySchema}'
```

---

## 4. GitHub Actions用OIDC設定

GitHub ActionsからAWSにアクセスするため、OIDCプロバイダーとIAMロールを作成する。
これにより、GitHub ActionsのワークフローがアクセスキーなしでセキュアにAWSリソースを操作できるようになる。

### 4.1 OIDCプロバイダーの作成

1. AWSコンソールで「IAM」を検索して開く
2. 左側メニューの「IDプロバイダ」をクリック
3. 「プロバイダを追加」ボタンをクリック
4. 以下を設定：
   - プロバイダのタイプ：「OpenID Connect」を選択
   - プロバイダのURL：`https://token.actions.githubusercontent.com`
   - 対象者：`sts.amazonaws.com`
5. 「サムプリントを取得」をクリック
6. 「プロバイダを追加」をクリック

### 4.2 IAMポリシーの作成

GitHub ActionsがTerraformの実行およびデプロイに必要な権限を持つポリシーを作成する。

1. IAMコンソールの左側メニューから「ポリシー」をクリック
2. 「ポリシーの作成」をクリック
3. 「JSON」タブを選択し、以下のJSONを入力：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "TerraformBackend",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::keirekipro-terraform-state",
        "arn:aws:s3:::keirekipro-terraform-state/*"
      ]
    },
    {
      "Sid": "TerraformLock",
      "Effect": "Allow",
      "Action": [
        "dynamodb:GetItem",
        "dynamodb:PutItem",
        "dynamodb:DeleteItem"
      ],
      "Resource": "arn:aws:dynamodb:ap-northeast-1:*:table/keirekipro-terraform-lock"
    },
    {
      "Sid": "TerraformFullAccess",
      "Effect": "Allow",
      "Action": [
        "ec2:*",
        "elasticloadbalancing:*",
        "ecs:*",
        "ecr:*",
        "rds:*",
        "elasticache:*",
        "s3:*",
        "cloudfront:*",
        "route53:*",
        "acm:*",
        "secretsmanager:*",
        "iam:*",
        "logs:*",
        "cloudwatch:*",
        "sns:*",
        "ses:*",
        "wafv2:*",
        "application-autoscaling:*"
      ],
      "Resource": "*"
    }
  ]
}
```

4. 「次へ」をクリック
5. ポリシー名に `keirekipro-github-actions-policy` と入力
6. 「ポリシーの作成」をクリック

### 4.3 IAMロールの作成

1. IAMコンソールの左側メニューから「ロール」をクリック
2. 「ロールを作成」をクリック
3. 信頼されたエンティティタイプで「ウェブアイデンティティ」を選択
4. 以下を設定：
   - IDプロバイダー：`token.actions.githubusercontent.com` を選択
   - Audience：`sts.amazonaws.com` を選択
   - GitHub組織：自分のGitHubユーザー名またはOrganization名を入力
   - GitHubリポジトリ：`KeirekiPro`（リポジトリ名を入力）
   - GitHubブランチ：空欄のまま（すべてのブランチを許可）
5. 「次へ」をクリック
6. 許可ポリシーで `keirekipro-github-actions-policy` を検索し、チェックを入れる
7. 「次へ」をクリック
8. ロール名に `keirekipro-github-actions-role` と入力
9. 「ロールを作成」をクリック

### 4.4 信頼ポリシーの確認

作成したロールの信頼ポリシーが正しく設定されていることを確認する。

1. IAMコンソールの「ロール」から `keirekipro-github-actions-role` をクリック
2. 「信頼関係」タブをクリック
3. 以下のような内容になっていることを確認：

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::<AWSアカウントID>:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:<GitHubユーザー名>/KeirekiPro:*"
        }
      }
    }
  ]
}
```

### 4.5 作成結果の確認

```bash
# OIDCプロバイダーの確認
aws iam list-open-id-connect-providers

# IAMロールの確認
aws iam get-role --role-name keirekipro-github-actions-role --query 'Role.Arn'
```

出力例：
```
"arn:aws:iam::123456789012:role/keirekipro-github-actions-role"
```

---

## 5. Google OAuth認証情報の取得

KeirekiProでGoogleアカウントによるログインを実現するため、Google Cloud ConsoleでOAuthクライアントを作成する。

### 5.1 Google Cloud Consoleにアクセス

1. ブラウザで [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. Googleアカウントでログイン

### 5.2 プロジェクトの作成（初回のみ）

1. 画面上部のプロジェクト選択ドロップダウンをクリック
2. 「新しいプロジェクト」をクリック
3. 以下を入力:
   - プロジェクト名: `keirekipro`
   - 場所: 組織がある場合は選択、なければ「組織なし」
4. 「作成」をクリック
5. 作成完了後、プロジェクト選択ドロップダウンから `keirekipro` を選択

### 5.3 OAuth同意画面の設定

1. 左側メニューから「APIとサービス」→「OAuth同意画面」をクリック
2. 「開始する」または「同意画面を設定」をクリック
3. User Typeで「外部」を選択し、「作成」をクリック
4. アプリ情報を入力:
   - アプリ名: `KeirekiPro`
   - ユーザーサポートメール: 自分のメールアドレス
   - デベロッパーの連絡先情報: 自分のメールアドレス
5. 「保存して次へ」をクリック
6. スコープの設定画面では何も追加せず「保存して次へ」をクリック
7. テストユーザーの画面で「ADD USERS」をクリックし、自分のメールアドレスを追加
8. 「保存して次へ」をクリック
9. 概要を確認し「ダッシュボードに戻る」をクリック

### 5.4 OAuthクライアントIDの作成

1. 左側メニューから「APIとサービス」→「認証情報」をクリック
2. 「+ 認証情報を作成」→「OAuthクライアントID」をクリック
3. 以下を入力:
   - アプリケーションの種類: 「ウェブアプリケーション」
   - 名前: `KeirekiPro Web Client`
   - 承認済みのJavaScriptオリジン: （空欄のまま）
   - 承認済みのリダイレクトURI: `https://app.keirekipro.click/api/auth/oidc/callback`
4. 「作成」をクリック
5. 表示される「クライアントID」と「クライアントシークレット」をメモ

**重要**: クライアントシークレットは作成時のみ表示される。必ずメモすること。

### 5.5 取得した認証情報

以下の2つの値を安全な場所にメモする:

| 項目 | 値の例 |
|------|--------|
| クライアントID | `123456789012-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com` |
| クライアントシークレット | `GOCSPX-xxxxxxxxxxxxxxxxxxxxxxxx` |

---

## 6. GitHub OAuth認証情報の取得

KeirekiProでGitHubアカウントによるログインを実現するため、GitHub Developer SettingsでOAuth Appを作成する。

### 6.1 GitHub Developer Settingsにアクセス

1. ブラウザで [GitHub](https://github.com/) にアクセスしてログイン
2. 右上のプロフィールアイコンをクリック
3. 「Settings」をクリック
4. 左側メニューを下にスクロールし、「Developer settings」をクリック

### 6.2 OAuth Appの作成

1. 左側メニューから「OAuth Apps」をクリック
2. 「New OAuth App」（または「Register a new application」）をクリック
3. 以下を入力:
   - Application name: `KeirekiPro`
   - Homepage URL: `https://app.keirekipro.click`
   - Application description: `履歴書作成Webアプリケーション`（任意）
   - Authorization callback URL: `https://app.keirekipro.click/api/auth/callback`
4. 「Register application」をクリック

### 6.3 クライアントシークレットの生成

1. アプリケーション登録完了後、設定画面が表示される
2. 「Client ID」をメモ
3. 「Generate a new client secret」をクリック
4. 生成された「Client secret」をメモ

**重要**: クライアントシークレットは生成時のみ表示される。紛失した場合は再生成が必要。

### 6.4 取得した認証情報

以下の2つの値を安全な場所にメモする:

| 項目 | 値の例 |
|------|--------|
| Client ID | `Iv1.xxxxxxxxxxxxxxxx` または `Ov23liXXXXXXXXXXXXXX` |
| Client secret | `xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` |

---

## 7. JWT署名鍵の生成

JWTトークンの署名に使用する秘密鍵を生成する。

### 7.1 ランダムな署名鍵の生成

```bash
# 64文字のランダムな文字列を生成
openssl rand -base64 48
```

出力例:
```
xK7mN2pQ9rS4tU6vW8xY1zA3bC5dE7fG9hI0jK2lM4nO6pQ8rS0tU2vW4xY6zA8b
```

この値をメモする。

---

## 8. GitHub Secretsへの機密情報登録

Terraform実行時に使用する機密情報をGitHub Secretsに登録する。

### 8.1 GitHub Secretsにアクセス

1. ブラウザでKeirekiProのGitHubリポジトリにアクセス
2. 「Settings」タブをクリック
3. 左側メニューから「Secrets and variables」→「Actions」をクリック

### 8.2 Secretsの登録

「New repository secret」をクリックし、以下の各項目を1つずつ登録する。

| Name | Secret（値） |
|------|-------------|
| `TF_VAR_jwt_secret` | 手順7で生成したJWT署名鍵 |
| `TF_VAR_google_oauth_client_id` | 手順5で取得したGoogleクライアントID |
| `TF_VAR_google_oauth_client_secret` | 手順5で取得したGoogleクライアントシークレット |
| `TF_VAR_github_oauth_client_id` | 手順6で取得したGitHubクライアントID |
| `TF_VAR_github_oauth_client_secret` | 手順6で取得したGitHubクライアントシークレット |
| `TF_VAR_alert_email_address` | CloudWatchアラート通知先メールアドレス |
| `AWS_ACCOUNT_ID` | AWSアカウントID（12桁の数字） |

### 8.3 登録確認

「Repository secrets」セクションに上記7つのシークレットが表示されていることを確認する。

---

## 9. Terraform実行後の作業

Terraform適用後に実施する作業である。

### 9.1 SNS Emailサブスクリプションの確認

Terraform適用後、CloudWatchアラート通知用のメールサブスクリプション確認が必要である。

1. `TF_VAR_alert_email_address` に登録したメールアドレスの受信トレイを確認
2. 「AWS Notification - Subscription Confirmation」という件名のメールを開く
3. メール本文内の「Confirm subscription」リンクをクリック
4. ブラウザに「Subscription confirmed!」と表示されれば完了

**注意**: 確認が完了するまでCloudWatchアラームの通知は届かない。

### 9.2 Amazon SESサンドボックス解除申請

アプリケーションがデプロイされ、`https://app.keirekipro.click` にアクセスできるようになってから実施する。

1. AWSコンソールで「Amazon SES」を開く（リージョン：東京）
2. 左メニューの「アカウントダッシュボード」をクリック
3. 「Amazon SESアカウントは以下のサンドボックスにあります」の警告ボックス内にある「本稼働アクセスのリクエスト」をクリック
4. 以下を入力：
   - メールタイプ：トランザクション
   - ウェブサイトのURL：`https://app.keirekipro.click`
   - ユースケースの説明：以下の内容を入力

```
【サービス概要】
エンジニア向けの職務経歴書作成Webアプリケーション（ポートフォリオプロジェクト）

【メール送信用途】
- ユーザー登録時のメールアドレス確認
- パスワードリセット
- 二要素認証コードの送信

【送信元アドレス】
info@keirekipro.click

【想定送信量】
1日あたり10通以下（ポートフォリオ用途のため利用者は限定的）

【オプトイン】
ユーザー自身がアカウント登録フォームからメールアドレスを入力して登録する形式である。マーケティングメールや一方的な送信は行わない。

【バウンス・苦情対策】
- トランザクションメールのみ送信（登録確認、パスワードリセット、二要素認証）
- ユーザーが自ら登録したアドレスにのみ送信
- バウンスが発生した場合は該当アドレスへの送信を停止

【設定済み項目】
- ドメイン検証：完了
- DKIM：有効（2048ビット）
- SPF：設定済み
- DMARC：設定済み（p=quarantine）
- カスタムMAIL FROMドメイン：設定済み
```

5. 「リクエストを送信」をクリック

### 9.3 サンドボックス解除の承認を待つ

- 最大24時間以内に返答がある
- 承認されると、サンドボックスが解除される

### 9.4 サンドボックス解除確認

1. SESコンソールの「アカウントダッシュボード」を開く
2. 「サンドボックス」の表示が消えていることを確認
