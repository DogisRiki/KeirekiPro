# GitHub Actions CI/CD設計書

## 1. ワークフロー設計

### 1.1 ワークフロー一覧

| ワークフロー名 | ファイル名 | トリガー | 依存関係 | 用途 |
|--------------|-----------|---------|---------|------|
| CI Workflow | ci.yaml | push（main）、PR（main） | なし | フロントエンド・バックエンドのテスト・リント |
| Frontend Deploy | frontend-deploy.yaml | push（main、frontend/**変更時）、手動 | terraform-apply.yaml完了後に実行 | フロントエンドのビルド・S3デプロイ・CloudFrontキャッシュ無効化 |
| Backend Deploy | backend-deploy.yaml | push（main、backend/**変更時）、手動 | terraform-apply.yaml完了後に実行 | バックエンドのDockerビルド・ECRプッシュ・ECSサービスの希望タスク数を1に更新・ECSデプロイ |
| Terraform Plan | terraform-plan.yaml | PR（main、terraform/**変更時） | なし | Terraformプラン実行・PRへのコメント |
| Terraform Apply | terraform-apply.yaml | push（main、terraform/**変更時）、手動 | なし | Terraformアプライ実行 |

### 1.2 ワークフロー実行フロー

#### 1.2.1 Pull Request作成時
```
PRを作成
    │
    ├─── frontend/**変更あり ──→ CI Workflow（フロントエンドのテスト・リント）
    │
    ├─── backend/**変更あり ───→ CI Workflow（バックエンドのテスト・リント）
    │
    └─── terraform/**変更あり ─→ Terraform Plan（plan結果をPRにコメント）

    ↓
レビュー・承認
    ↓
mainにマージ
```

#### 1.2.2 初回デプロイ時（mainへのマージ）

terraform/、backend/、frontend/すべてに変更がある状態。
```
mainにマージ
    │
    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ Step 1: terraform-apply.yaml                                        │
│ - ECRリポジトリ作成                                                  │
│ - ECSクラスター、サービス作成（希望タスク数0）                         │
│ - ALB、CloudFront、S3バケット等を作成                                │
└─────────────────────────────────────────────────────────────────────┘
    │
    │ 完了後
    ▼
┌─────────────────────────────────┐    ┌─────────────────────────────────┐
│ Step 2: backend-deploy.yaml     │    │ Step 2: frontend-deploy.yaml    │
│ - Dockerイメージをビルド         │    │ - フロントエンドをビルド          │
│ - ECRにプッシュ                  │    │ - S3にアップロード               │
│ - ECSサービスの希望タスク数を1に  │    │ - CloudFrontキャッシュ無効化     │
│   更新してデプロイ               │    │                                 │
└─────────────────────────────────┘    └─────────────────────────────────┘
         （並列実行）
```

#### 1.2.3 通常運用時（2回目以降、mainへのマージ）

変更されたファイルに応じて必要なワークフローのみ実行。
```
mainにマージ
    │
    ├─── terraform/**のみ変更 ──→ terraform-apply.yamlのみ実行
    │
    ├─── backend/**のみ変更 ───→ backend-deploy.yamlのみ実行
    │
    └─── frontend/**のみ変更 ──→ frontend-deploy.yamlのみ実行
```

複数のディレクトリに変更がある場合は、該当するワークフローがすべて実行される。terraform/**に変更がある場合は、terraform-apply.yaml完了後にbackend-deploy.yaml、frontend-deploy.yamlが実行される。

### 1.3 GitHub Secretsに登録する値

| シークレット名 | 用途 |
|--------------|------|
| AWS_ACCOUNT_ID | AWSアカウントID（12桁） |
| TF_VAR_jwt_secret | JWT署名鍵 |
| TF_VAR_google_oauth_client_id | Google OAuthクライアントID |
| TF_VAR_google_oauth_client_secret | Google OAuthクライアントシークレット |
| TF_VAR_github_oauth_client_id | GitHub OAuthクライアントID |
| TF_VAR_github_oauth_client_secret | GitHub OAuthクライアントシークレット |
| TF_VAR_alert_email_address | CloudWatchアラート通知先メールアドレス |

### 1.4 OIDC連携

GitHub ActionsからAWSへの認証はOIDC連携を使用する。IAMロール`keirekipro-github-actions-role`の信頼ポリシーで、特定リポジトリからのAssumeRoleWithWebIdentityのみを許可する。

### 1.5 デプロイ戦略

| 対象 | 戦略 |
|------|------|
| フロントエンド | S3同期 + CloudFrontキャッシュ無効化 |
| バックエンド | ECSローリングアップデート（最小ヘルス率100%、最大率200%、回路ブレーカー有効） |

### 1.6 Terraform Plan PRコメント

terraform-plan.yamlでPRにplan結果をコメントする際は、hashicorp/setup-terraform + github-scriptを使用する。

| ツール/Action | 説明 |
|--------------|------|
| hashicorp/setup-terraform | Terraform公式Action |
| actions/github-script | `terraform show`の出力をPRにコメント |

### 1.7 承認プロセス

terraform-apply.yaml実行前の承認プロセスは設定しない（ポートフォリオ用途のため）。

本番運用で承認プロセスが必要な場合は、GitHubの「Environment protection rules」を使用して、特定ユーザーの承認を必須にできる。

### 1.8 frontend-deploy.yaml 詳細設定

| 項目 | 設定値 |
|------|--------|
| ビルドコマンド | `npm ci --ignore-scripts --no-audit --no-fund && npm run build` |
| ビルド成果物の出力ディレクトリ | `dist` |
| S3同期コマンド | `aws s3 sync dist/ s3://keirekipro-frontend --delete` |

### 1.9 backend-deploy.yaml 詳細設定

| 項目 | 設定値 |
|------|--------|
| Dockerイメージのタグ付け | コミットハッシュ（`${{ github.sha }}`）を使用 |
| ECSデプロイ完了の待機処理 | あり（`aws ecs wait services-stable`を使用） |
