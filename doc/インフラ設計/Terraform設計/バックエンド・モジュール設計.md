# Terraformバックエンド・モジュール設計書

## 1. バックエンド設計

### 1.1 S3バックエンド設定

| 項目 | 設定値 |
|------|--------|
| バケット名 | keirekipro-terraform-state |
| キー | terraform.tfstate |
| リージョン | ap-northeast-1 |
| 暗号化 | 有効（SSE-S3） |
| バージョニング | 有効 |

### 1.2 DynamoDBロックテーブル設定

| 項目 | 設定値 |
|------|--------|
| テーブル名 | keirekipro-terraform-lock |
| パーティションキー | LockID（String） |
| 課金モード | PAY_PER_REQUEST（オンデマンド） |
| リージョン | ap-northeast-1 |

### 1.3 バックエンド設定ファイル

```hcl
# backend.tf
terraform {
  backend "s3" {
    bucket         = "keirekipro-terraform-state"
    key            = "terraform.tfstate"
    region         = "ap-northeast-1"
    encrypt        = true
    dynamodb_table = "keirekipro-terraform-lock"
  }
}
```

## 2. ディレクトリ構成設計

```
terraform/
├── backend.tf                    # バックエンド設定
├── main.tf                       # プロバイダー設定、データソース
├── variables.tf                  # 入力変数定義
├── outputs.tf                    # 出力値定義
├── locals.tf                     # ローカル変数定義
├── versions.tf                   # Terraformバージョン制約
│
├── modules/                      # 再利用可能なモジュール
│   ├── vpc/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── rds/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── elasticache/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── ecs/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── alb/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── s3/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── cloudfront/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── waf/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── route53/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── acm/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── ses/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── cloudwatch/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   ├── secrets-manager/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── outputs.tf
│   └── iam/
│       ├── main.tf
│       ├── variables.tf
│       └── outputs.tf
│
└── environments/                 # 環境固有設定（将来の拡張用）
    └── prod/
        └── terraform.tfvars
```

## 3. モジュール分割設計

### 3.1 モジュール一覧

| モジュール名 | 責務 | 依存モジュール |
|-------------|------|---------------|
| vpc | VPC、サブネット、ルートテーブル、IGW、NAT GW、VPCエンドポイント、セキュリティグループ | なし |
| iam | IAMロール、IAMポリシー、OIDCプロバイダー | なし |
| secrets-manager | Secrets Managerシークレット | なし |
| rds | RDSインスタンス、サブネットグループ、パラメータグループ | vpc, secrets-manager |
| elasticache | ElastiCacheクラスター、サブネットグループ、パラメータグループ | vpc, secrets-manager |
| s3 | S3バケット、ライフサイクルルール | なし |
| acm | ACM証明書（us-east-1、ap-northeast-1） | route53 |
| alb | ALB、ターゲットグループ、リスナー、リスナールール | vpc, acm, s3, secrets-manager |
| ecs | ECRリポジトリ、ECSクラスター、タスク定義、サービス | vpc, iam, alb, secrets-manager |
| cloudfront | CloudFrontディストリビューション、OAC | s3, acm, alb, secrets-manager |
| waf | WAF Web ACL、ルール | cloudfront |
| route53 | Route 53レコード | cloudfront |
| ses | SES設定セット | route53 |
| cloudwatch | ロググループ、アラーム、SNSトピック、ダッシュボード | ecs, alb, rds, elasticache |

### 3.2 モジュール依存関係図

```
                    ┌─────────────┐
                    │     vpc     │
                    └──────┬──────┘
           ┌───────────────┼───────────────┬────────────────┐
           │               │               │                │
           ▼               ▼               ▼                ▼
    ┌──────────┐    ┌──────────┐    ┌───────────┐    ┌─────────┐
    │   rds    │    │elasticache│   │    alb    │    │   ecs   │
    └──────────┘    └──────────┘    └─────┬─────┘    └────┬────┘
                                          │               │
                    ┌─────────────────────┴───────────────┘
                    │
                    ▼
             ┌────────────┐      ┌─────────────┐
             │ cloudfront │──────│     waf     │
             └──────┬─────┘      └─────────────┘
                    │
                    ▼
             ┌────────────┐      ┌─────────────┐
             │  route53   │──────│     acm     │
             └──────┬─────┘      └─────────────┘
                    │
                    ▼
             ┌────────────┐
             │    ses     │
             └────────────┘

    ┌─────────────────────────────────────────────────────────┐
    │                      cloudwatch                         │
    │  (ecs, alb, rds, elasticacheのメトリクスを監視)           │
    └─────────────────────────────────────────────────────────┘

    ┌─────────────┐    ┌─────────────────┐    ┌─────────┐
    │     iam     │    │ secrets-manager │    │   s3    │
    │ (独立管理)   │    │   (独立管理)    │    │(独立管理)│
    └─────────────┘    └─────────────────┘    └─────────┘
```

### 3.3 S3とCloudFrontの循環依存の解決

S3バケットポリシーはCloudFront ARNを必要とし、CloudFrontはS3ドメイン名を必要とする循環依存がある。

解決方法：
1. S3バケットを先に作成（バケットポリシーなし）
2. CloudFrontを作成
3. S3バケットポリシーを別リソース（`aws_s3_bucket_policy`）として作成し、CloudFront ARNを参照

s3モジュールではバケットポリシーを作成せず、ルートモジュールでCloudFront作成後にバケットポリシーを適用する。

### 3.4 Route 53ホストゾーン参照

Route 53ホストゾーンは手動作業で作成済みのため、Terraformでは`data`ソースを使用して参照する。

ルートモジュール（main.tf）で以下のように定義：

```hcl
data "aws_route53_zone" "main" {
  name         = var.domain_name
  private_zone = false
}
```

取得した`zone_id`を各モジュール（acm、route53）に渡す。

### 3.5 各モジュールのリソース定義

#### 3.5.1 vpcモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_vpc | keirekipro-vpc |
| aws_subnet | keirekipro-public-1a, keirekipro-public-1c, keirekipro-private-1a, keirekipro-private-1c |
| aws_internet_gateway | keirekipro-igw |
| aws_nat_gateway | keirekipro-nat |
| aws_eip | keirekipro-nat-eip |
| aws_route_table | keirekipro-public-rt, keirekipro-private-rt |
| aws_route_table_association | パブリック2つ、プライベート2つ |
| aws_security_group | keirekipro-alb-sg, keirekipro-ecs-sg, keirekipro-rds-sg, keirekipro-redis-sg, keirekipro-vpce-sg |
| aws_vpc_endpoint | S3（Gateway）、ECR API、ECR DKR、CloudWatch Logs、Secrets Manager（Interface） |

#### 3.5.2 iamモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_iam_role | keirekipro-ecs-task-execution-role, keirekipro-ecs-task-role, keirekipro-github-actions-role |
| aws_iam_policy | keirekipro-ecs-secrets-policy, keirekipro-app-secrets-policy, keirekipro-s3-policy, keirekipro-ses-policy, keirekipro-github-actions-policy |
| aws_iam_role_policy_attachment | 各ロールへのポリシーアタッチ |
| aws_iam_openid_connect_provider | GitHub Actions OIDC |

#### 3.5.3 secrets-managerモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_secretsmanager_secret | keirekipro/rds, keirekipro/redis, keirekipro/jwt, keirekipro/oidc/google, keirekipro/oidc/github, keirekipro/alb-origin-verify |
| aws_secretsmanager_secret_version | 各シークレットの値 |
| random_password | RDSパスワード、Redisパスワード、ALB Origin Verify値 |

#### 3.5.4 rdsモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_db_instance | keirekipro-db |
| aws_db_subnet_group | keirekipro-db-subnet-group |
| aws_db_parameter_group | keirekipro-db-params |

#### 3.5.5 elasticacheモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_elasticache_cluster | keirekipro-redis |
| aws_elasticache_subnet_group | keirekipro-redis-subnet-group |
| aws_elasticache_parameter_group | keirekipro-redis-params |

#### 3.5.6 s3モジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_s3_bucket | keirekipro-frontend, keirekipro-storage, keirekipro-alb-logs |
| aws_s3_bucket_versioning | 各バケット設定 |
| aws_s3_bucket_server_side_encryption_configuration | 各バケット設定 |
| aws_s3_bucket_public_access_block | 各バケット設定 |
| aws_s3_bucket_cors_configuration | keirekipro-storage |
| aws_s3_bucket_lifecycle_configuration | keirekipro-alb-logs |

※ バケットポリシー（`aws_s3_bucket_policy`）はs3モジュールでは作成しない。CloudFront作成後にルートモジュールで作成する。

#### 3.5.7 acmモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_acm_certificate | app.keirekipro.click（us-east-1）, app.keirekipro.click（ap-northeast-1） |
| aws_acm_certificate_validation | 各証明書のDNS検証 |

#### 3.5.8 albモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_lb | keirekipro-alb |
| aws_lb_target_group | keirekipro-backend-tg |
| aws_lb_listener | HTTPS:443 |
| aws_lb_listener_rule | X-Origin-Verify検証ルール |

#### 3.5.9 ecsモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_ecr_repository | keirekipro-backend |
| aws_ecr_lifecycle_policy | 5世代保持 |
| aws_ecs_cluster | keirekipro-cluster |
| aws_ecs_task_definition | keirekipro-backend-task |
| aws_ecs_service | keirekipro-backend-service |
| aws_appautoscaling_target | ECSサービスのオートスケーリング |
| aws_appautoscaling_policy | CPU使用率ターゲット追跡 |

#### 3.5.10 cloudfrontモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_cloudfront_distribution | keirekipro-distribution |
| aws_cloudfront_origin_access_control | keirekipro-frontend-oac, keirekipro-storage-oac |

#### 3.5.11 wafモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_wafv2_web_acl | keirekipro-waf-acl |

#### 3.5.12 route53モジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_route53_record | app.keirekipro.click（A、AAAA）、ACM検証レコード |

※ ホストゾーンはルートモジュールで`data "aws_route53_zone"`を使用して参照し、`zone_id`をこのモジュールに渡す。

#### 3.5.13 sesモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_ses_configuration_set | keirekipro-config-set |

#### 3.5.14 cloudwatchモジュール

| リソース種別 | リソース名 |
|-------------|-----------|
| aws_cloudwatch_log_group | /ecs/keirekipro-backend |
| aws_cloudwatch_metric_alarm | keirekipro-ecs-cpu-high, keirekipro-ecs-memory-high, keirekipro-alb-5xx-high, keirekipro-alb-unhealthy, keirekipro-rds-cpu-high, keirekipro-rds-storage-low, keirekipro-redis-memory-high |
| aws_sns_topic | keirekipro-alerts |
| aws_sns_topic_subscription | Eメール通知 |
| aws_cloudwatch_dashboard | keirekipro-dashboard |

## 4. 変数・出力設計

### 4.1 ルートモジュール入力変数（variables.tf）

| 変数名 | 型 | 必須 | デフォルト値 | 説明 |
|--------|-----|------|-------------|------|
| aws_region | string | いいえ | ap-northeast-1 | AWSリージョン |
| project_name | string | いいえ | keirekipro | プロジェクト名 |
| domain_name | string | いいえ | keirekipro.click | ドメイン名 |
| app_domain_name | string | いいえ | app.keirekipro.click | アプリケーションドメイン名 |
| jwt_secret | string | はい | - | JWT署名鍵 |
| google_oauth_client_id | string | はい | - | Google OAuthクライアントID |
| google_oauth_client_secret | string | はい | - | Google OAuthクライアントシークレット |
| github_oauth_client_id | string | はい | - | GitHub OAuthクライアントID |
| github_oauth_client_secret | string | はい | - | GitHub OAuthクライアントシークレット |
| alert_email_address | string | はい | - | CloudWatchアラート通知先メールアドレス |
| github_org | string | はい | - | GitHubオーガニゼーション名 |
| github_repo | string | はい | - | GitHubリポジトリ名 |

### 4.2 ルートモジュール出力値（outputs.tf）

| 出力名 | 説明 |
|--------|------|
| vpc_id | VPC ID |
| cloudfront_distribution_id | CloudFrontディストリビューションID |
| cloudfront_distribution_domain_name | CloudFrontディストリビューションドメイン名 |
| ecr_repository_url | ECRリポジトリURL |
| ecs_cluster_name | ECSクラスター名 |
| ecs_service_name | ECSサービス名 |
| alb_dns_name | ALBのDNS名 |
| rds_endpoint | RDSエンドポイント |
| redis_endpoint | Redisエンドポイント |
| s3_frontend_bucket_name | フロントエンドS3バケット名 |
| github_actions_role_arn | GitHub Actions用IAMロールARN |

### 4.3 各モジュールの入出力設計

#### 4.3.1 vpcモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| vpc_cidr | string | VPC CIDR |
| public_subnet_cidrs | list(string) | パブリックサブネットCIDRリスト |
| private_subnet_cidrs | list(string) | プライベートサブネットCIDRリスト |
| availability_zones | list(string) | アベイラビリティゾーンリスト |

出力値:

| 出力名 | 説明 |
|--------|------|
| vpc_id | VPC ID |
| public_subnet_ids | パブリックサブネットIDリスト |
| private_subnet_ids | プライベートサブネットIDリスト |
| alb_security_group_id | ALB用セキュリティグループID |
| ecs_security_group_id | ECS用セキュリティグループID |
| rds_security_group_id | RDS用セキュリティグループID |
| redis_security_group_id | Redis用セキュリティグループID |

#### 4.3.2 iamモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| aws_account_id | string | AWSアカウントID |
| github_org | string | GitHubオーガニゼーション名 |
| github_repo | string | GitHubリポジトリ名 |
| secrets_manager_secret_arns | list(string) | Secrets ManagerシークレットARNリスト |
| s3_storage_bucket_arn | string | S3ストレージバケットARN |
| s3_frontend_bucket_arn | string | S3フロントエンドバケットARN |
| ecr_repository_arn | string | ECRリポジトリARN |

出力値:

| 出力名 | 説明 |
|--------|------|
| ecs_task_execution_role_arn | ECSタスク実行ロールARN |
| ecs_task_role_arn | ECSタスクロールARN |
| github_actions_role_arn | GitHub Actions用IAMロールARN |

#### 4.3.3 secrets-managerモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| rds_host | string | RDSホスト名 |
| rds_port | number | RDSポート番号 |
| rds_database | string | RDSデータベース名 |
| rds_username | string | RDSユーザー名 |
| redis_host | string | Redisホスト名 |
| redis_port | number | Redisポート番号 |
| jwt_secret | string | JWT署名鍵 |
| google_oauth_client_id | string | Google OAuthクライアントID |
| google_oauth_client_secret | string | Google OAuthクライアントシークレット |
| github_oauth_client_id | string | GitHub OAuthクライアントID |
| github_oauth_client_secret | string | GitHub OAuthクライアントシークレット |

出力値:

| 出力名 | 説明 |
|--------|------|
| rds_secret_arn | RDSシークレットARN |
| redis_secret_arn | RedisシークレットARN |
| jwt_secret_arn | JWTシークレットARN |
| google_oauth_secret_arn | Google OAuthシークレットARN |
| github_oauth_secret_arn | GitHub OAuthシークレットARN |
| alb_origin_verify_secret_arn | ALB Origin VerifyシークレットARN |
| alb_origin_verify_header_value | ALB Origin Verifyヘッダー値 |
| rds_password | RDSパスワード（sensitive） |
| redis_password | Redisパスワード（sensitive） |

#### 4.3.4 rdsモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| private_subnet_ids | list(string) | プライベートサブネットIDリスト |
| security_group_id | string | セキュリティグループID |
| db_password | string | データベースパスワード |

出力値:

| 出力名 | 説明 |
|--------|------|
| endpoint | RDSエンドポイント |
| port | RDSポート番号 |
| database_name | データベース名 |
| username | ユーザー名 |

#### 4.3.5 elasticacheモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| private_subnet_ids | list(string) | プライベートサブネットIDリスト |
| security_group_id | string | セキュリティグループID |
| auth_token | string | 認証トークン |

出力値:

| 出力名 | 説明 |
|--------|------|
| endpoint | Redisエンドポイント |
| port | Redisポート番号 |

#### 4.3.6 s3モジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| aws_account_id | string | AWSアカウントID |

出力値:

| 出力名 | 説明 |
|--------|------|
| frontend_bucket_name | フロントエンドバケット名 |
| frontend_bucket_arn | フロントエンドバケットARN |
| frontend_bucket_regional_domain_name | フロントエンドバケットリージョナルドメイン名 |
| storage_bucket_name | ストレージバケット名 |
| storage_bucket_arn | ストレージバケットARN |
| storage_bucket_regional_domain_name | ストレージバケットリージョナルドメイン名 |
| alb_logs_bucket_name | ALBログバケット名 |

#### 4.3.7 acmモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| domain_name | string | ドメイン名 |
| app_domain_name | string | アプリケーションドメイン名 |
| route53_zone_id | string | Route 53ホストゾーンID |

出力値:

| 出力名 | 説明 |
|--------|------|
| cloudfront_certificate_arn | CloudFront用証明書ARN（us-east-1） |
| alb_certificate_arn | ALB用証明書ARN（ap-northeast-1） |

#### 4.3.8 albモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| vpc_id | string | VPC ID |
| public_subnet_ids | list(string) | パブリックサブネットIDリスト |
| security_group_id | string | セキュリティグループID |
| certificate_arn | string | ACM証明書ARN |
| alb_logs_bucket_name | string | ALBログバケット名 |
| origin_verify_header_value | string | Origin Verifyヘッダー値 |

出力値:

| 出力名 | 説明 |
|--------|------|
| alb_arn | ALB ARN |
| alb_dns_name | ALB DNS名 |
| target_group_arn | ターゲットグループARN |

#### 4.3.9 ecsモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| aws_region | string | AWSリージョン |
| aws_account_id | string | AWSアカウントID |
| private_subnet_ids | list(string) | プライベートサブネットIDリスト |
| security_group_id | string | セキュリティグループID |
| task_execution_role_arn | string | タスク実行ロールARN |
| task_role_arn | string | タスクロールARN |
| target_group_arn | string | ターゲットグループARN |
| log_group_name | string | CloudWatch Logsロググループ名 |

出力値:

| 出力名 | 説明 |
|--------|------|
| ecr_repository_url | ECRリポジトリURL |
| ecr_repository_arn | ECRリポジトリARN |
| cluster_name | ECSクラスター名 |
| service_name | ECSサービス名 |

#### 4.3.10 cloudfrontモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| app_domain_name | string | アプリケーションドメイン名 |
| certificate_arn | string | ACM証明書ARN（us-east-1） |
| frontend_bucket_regional_domain_name | string | フロントエンドバケットドメイン名 |
| storage_bucket_regional_domain_name | string | ストレージバケットドメイン名 |
| alb_dns_name | string | ALB DNS名 |
| origin_verify_header_value | string | Origin Verifyヘッダー値 |
| waf_web_acl_arn | string | WAF Web ACL ARN |

出力値:

| 出力名 | 説明 |
|--------|------|
| distribution_id | ディストリビューションID |
| distribution_arn | ディストリビューションARN |
| distribution_domain_name | ディストリビューションドメイン名 |
| frontend_oac_id | フロントエンドOAC ID |
| storage_oac_id | ストレージOAC ID |

#### 4.3.11 wafモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |

出力値:

| 出力名 | 説明 |
|--------|------|
| web_acl_arn | Web ACL ARN |

#### 4.3.12 route53モジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| zone_id | string | ホストゾーンID（ルートモジュールから渡される） |
| app_domain_name | string | アプリケーションドメイン名 |
| cloudfront_distribution_domain_name | string | CloudFrontディストリビューションドメイン名 |
| cloudfront_hosted_zone_id | string | CloudFrontホストゾーンID（固定値: Z2FDTNDATAQYW2） |

出力値:

| 出力名 | 説明 |
|--------|------|
| app_record_name | アプリケーションレコード名 |

#### 4.3.13 sesモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |

出力値:

| 出力名 | 説明 |
|--------|------|
| configuration_set_name | 設定セット名 |

#### 4.3.14 cloudwatchモジュール

入力変数:

| 変数名 | 型 | 説明 |
|--------|-----|------|
| project_name | string | プロジェクト名 |
| ecs_cluster_name | string | ECSクラスター名 |
| ecs_service_name | string | ECSサービス名 |
| alb_arn_suffix | string | ALB ARNサフィックス |
| target_group_arn_suffix | string | ターゲットグループARNサフィックス |
| rds_instance_identifier | string | RDSインスタンス識別子 |
| redis_cluster_id | string | RedisクラスターID |
| alert_email_address | string | アラート通知先メールアドレス |

出力値:

| 出力名 | 説明 |
|--------|------|
| log_group_name | ロググループ名 |
| sns_topic_arn | SNSトピックARN |

## 5. 環境分離設計（dev/prod）

### 5.1 環境分離方針

本プロジェクトはポートフォリオ用途であり、dev環境はLocalStackを使用したローカル開発環境、prod環境のみAWSにデプロイする構成とする。

| 環境 | 用途 | 実行場所 | 状態管理 |
|-----|------|---------|---------|
| dev | ローカル開発 | Docker Compose + LocalStack | なし（ローカル） |
| prod | 本番 | AWS | S3 + DynamoDB |

### 5.2 環境固有設定

prod環境の設定は`environments/prod/terraform.tfvars`で管理する。

```hcl
# environments/prod/terraform.tfvars
aws_region      = "ap-northeast-1"
project_name    = "keirekipro"
domain_name     = "keirekipro.click"
app_domain_name = "app.keirekipro.click"

# 以下はGitHub Secretsから環境変数経由で注入
# jwt_secret
# google_oauth_client_id
# google_oauth_client_secret
# github_oauth_client_id
# github_oauth_client_secret
# alert_email_address
# github_org
# github_repo
```

### 5.3 機密情報の管理

| 機密情報 | 管理場所 | 注入方法 |
|---------|---------|---------|
| JWT署名鍵 | GitHub Secrets | TF_VAR_jwt_secret |
| Google OAuthクライアントID | GitHub Secrets | TF_VAR_google_oauth_client_id |
| Google OAuthクライアントシークレット | GitHub Secrets | TF_VAR_google_oauth_client_secret |
| GitHub OAuthクライアントID | GitHub Secrets | TF_VAR_github_oauth_client_id |
| GitHub OAuthクライアントシークレット | GitHub Secrets | TF_VAR_github_oauth_client_secret |
| アラート通知メールアドレス | GitHub Secrets | TF_VAR_alert_email_address |
| RDSパスワード | Terraform random_password | Secrets Managerに自動保存 |
| Redisパスワード | Terraform random_password | Secrets Managerに自動保存 |
| ALB Origin Verify値 | Terraform random_password | Secrets Managerに自動保存 |

### 5.4 versions.tf

```hcl
terraform {
  required_version = ">= 1.0.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
}
```

### 5.5 locals.tf

```hcl
locals {
  common_tags = {
    Project     = var.project_name
    Environment = "prod"
    ManagedBy   = "Terraform"
  }
}
```
