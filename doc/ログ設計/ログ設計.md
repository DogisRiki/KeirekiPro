
# ログ設計書

## 1. 目的
- 障害時に「いつ・誰が・どの操作を実行し・成功/失敗したか・どこで失敗したか」を追跡可能にする
- 実行基盤でのログ集約にそのまま載せられる形式に標準化する
- 高度な分析基盤・分散トレース基盤の構築は目的外とし、運用の最低ラインを満たす

## 2. 前提と責務分界
### 2.1 出力先
- ログ出力先は stdout に固定する
- ファイル出力は行わない

### 2.2 集約
- stdout の収集・転送・保管は実行基盤側の責務とする
- アプリケーション側は「規格化されたログを stdout に出す」責務に限定する

## 3. ログ形式
### 3.1 形式
- 1イベント=1行の JSON（JSON Lines）で出力する
- 文字コードは UTF-8 とする

### 3.2 スキーマ
- ECS（Elastic Common Schema）に準拠したキー体系を採用する
- ECS に存在しない情報は `labels.*` を使用して拡張する
- 既存フィールドの意味を後から変えない（後方互換を優先）

### 3.3 レベル運用
- INFO: 正常系の実行記録（アクセス、ユースケース成功）
- WARN: 想定内の失敗（業務エラー、入力エラー）を要約して記録
- ERROR: 想定外の例外（スタックトレース必須）

## 4. 相関ID（Correlation）
### 4.1 requestId
- HTTP ヘッダ `X-Request-Id` を requestId として採用する
- リクエストに `X-Request-Id` が無い場合、サーバ側で生成する
- 生成/受領した requestId はレスポンスヘッダ `X-Request-Id` として返す
- ログには `labels.request_id` として必ず含める

### 4.2 traceId / spanId
- traceId/spanId をログに含める
- ログには `trace.id` と `span.id` として含める
- 外部へのトレース送信は行わない（相関IDの付与のみを目的とする）

## 5. 禁止事項（ログに出さない情報）
以下はログ出力を禁止する。
- パスワード
- JWT、リフレッシュトークン、認証コード等の機密値
- Cookie の値
- Authorization ヘッダ値
- Set-Cookie ヘッダ値
- リクエストボディ、レスポンスボディのダンプ
- メールアドレス等の個人情報（識別子として必要な場合は userId 等の匿名化済みIDのみ使用）

## 6. イベント設計
本システムのログイベントは次の3種に限定する。

### 6.1 HTTP アクセスログ
- `event.action`: `http_request`
- 目的: API 実行の成否と性能を 1リクエスト=1行で追えるようにする
- レベル: INFO
- 出力タイミング: リクエスト処理完了時（ステータス確定後）
- 必須フィールド:
  - `@timestamp`
  - `log.level`
  - `event.action` = `http_request`
  - `labels.request_id`
  - `trace.id`, `span.id`
  - `http.request.method`
  - `url.path`
  - `http.response.status_code`
  - `event.duration`
  - `user.id`（認証済みの場合のみ）
- 任意フィールド:
  - `client.address`
  - `user_agent.original`

### 6.2 ユースケース実行ログ
- `event.action`: `usecase`
- 目的: 業務処理単位の実行履歴を追えるようにする
- レベル:
  - 成功: INFO
  - 想定内失敗: WARN
- 出力回数: 1実行=1行
- 対象範囲:
  - 状態変更を伴うユースケース（コマンド系）を対象
  - 読み取り専用のクエリ処理は対象外
- 必須フィールド:
  - `@timestamp`
  - `log.level`
  - `event.action` = `usecase`
  - `labels.usecase`（ユースケース識別子）
  - `event.outcome` = `success` | `failure`
  - `labels.request_id`
  - `trace.id`, `span.id`
  - `event.duration`
  - `user.id`（認証済みの場合のみ）
- 任意フィールド:
  - `labels.aggregate_id`（例: resumeId 等）
  - `error.type`（failure の場合のみ。想定内失敗ではスタックトレースは出さない）

### 6.3 想定外例外ログ
- `event.action`: `unexpected_exception`
- 目的: 想定外障害の原因特定に必要な情報を残す
- レベル: ERROR
- 出力回数: 想定外例外 1件につき 1行
- 必須フィールド:
  - `@timestamp`
  - `log.level` = `ERROR`
  - `event.action` = `unexpected_exception`
  - `labels.request_id`
  - `trace.id`, `span.id`
  - `error.type`
  - `error.message`
  - `error.stack_trace`
  - `user.id`（認証済みの場合のみ）

### 6.4 ログ出力対象外
以下はログイベントとして出力しない。
- **入力バリデーションエラー（MethodArgumentNotValidException 等）**
  - クライアント起因のエラーであり、サーバー側の問題ではない
  - 頻繁に発生しうるため、すべてログ出力するとログ量が膨大になる
  - HTTP アクセスログの `http.response.status_code: 400` で追跡可能
  - 必要に応じて `labels.request_id` で詳細を調査できる

## 7. フィールド辞書
### 7.1 共通フィールド
| フィールド | 意味 | 必須 |
|---|---|---|
| `@timestamp` | 出力時刻（ISO-8601） | 必須 |
| `log.level` | ログレベル | 必須 |
| `message` | 人間向けの短文 | 推奨 |
| `event.action` | イベント種別識別子 | 必須 |
| `service.name` | サービス名 | 必須 |
| `service.environment` | 実行環境識別子 | 必須 |
| `labels.request_id` | requestId（X-Request-Id） | 必須 |
| `trace.id` | traceId | 必須 |
| `span.id` | spanId | 必須 |
| `user.id` | 認証済みユーザーID | 条件付き |

### 7.2 http_request フィールド
| フィールド | 意味 | 必須 |
|---|---|---|
| `http.request.method` | HTTPメソッド | 必須 |
| `url.path` | パス | 必須 |
| `http.response.status_code` | HTTPステータス | 必須 |
| `event.duration` | 処理時間 | 必須 |
| `client.address` | クライアントIP | 任意 |
| `user_agent.original` | User-Agent | 任意 |

### 7.3 usecase フィールド
| フィールド | 意味 | 必須 |
|---|---|---|
| `labels.usecase` | ユースケース識別子 | 必須 |
| `event.outcome` | 成否 | 必須 |
| `event.duration` | 処理時間 | 必須 |
| `labels.aggregate_id` | 対象集約の識別子 | 任意 |
| `error.type` | 例外種別（想定内失敗のみ） | 任意 |

### 7.4 unexpected_exception フィールド
| フィールド | 意味 | 必須 |
|---|---|---|
| `error.type` | 例外クラス等 | 必須 |
| `error.message` | 例外メッセージ | 必須 |
| `error.stack_trace` | スタックトレース | 必須 |

## 8. 例
### 8.1 http_request
```json
{"@timestamp":"2025-12-30T10:00:00.000Z","log.level":"INFO","message":"http_request","event.action":"http_request","service.name":"keirekipro","service.environment":"dev","labels.request_id":"7f2a6c52-8e4b-4d70-9c1e-5e7b2b0d5f4a","trace.id":"4bf92f3577b34da6a3ce929d0e0e4736","span.id":"00f067aa0ba902b7","http.request.method":"POST","url.path":"/api/resumes/123/careers","http.response.status_code":201,"event.duration":35,"user.id":"0f8fad5b-d9cb-469f-a165-70867728950e"}
```

### 8.2 usecase（成功）
```json
{"@timestamp":"2025-12-30T10:00:00.010Z","log.level":"INFO","message":"usecase","event.action":"usecase","service.name":"keirekipro","service.environment":"dev","labels.request_id":"7f2a6c52-8e4b-4d70-9c1e-5e7b2b0d5f4a","trace.id":"4bf92f3577b34da6a3ce929d0e0e4736","span.id":"00f067aa0ba902b7","labels.usecase":"CreateCareer","event.outcome":"success","event.duration":12,"user.id":"0f8fad5b-d9cb-469f-a165-70867728950e","labels.aggregate_id":"c1a3d2e4-1111-2222-3333-444455556666"}
```

### 8.3 usecase（想定内失敗）
```json
{"@timestamp":"2025-12-30T10:00:00.012Z","log.level":"WARN","message":"usecase_failed","event.action":"usecase","service.name":"keirekipro","service.environment":"dev","labels.request_id":"7f2a6c52-8e4b-4d70-9c1e-5e7b2b0d5f4a","trace.id":"4bf92f3577b34da6a3ce929d0e0e4736","span.id":"00f067aa0ba902b7","labels.usecase":"CreateCareer","event.outcome":"failure","event.duration":5,"error.type":"UseCaseException","user.id":"0f8fad5b-d9cb-469f-a165-70867728950e"}
```

### 8.4 unexpected_exception
```json
{"@timestamp":"2025-12-30T10:00:00.020Z","log.level":"ERROR","message":"unexpected_exception","event.action":"unexpected_exception","service.name":"keirekipro","service.environment":"dev","labels.request_id":"7f2a6c52-8e4b-4d70-9c1e-5e7b2b0d5f4a","trace.id":"4bf92f3577b34da6a3ce929d0e0e4736","span.id":"00f067aa0ba902b7","error.type":"java.lang.NullPointerException","error.message":"...","error.stack_trace":"...","user.id":"0f8fad5b-d9cb-469f-a165-70867728950e"}
```

## 9. 互換性と変更ルール
- 既存フィールドの意味変更は禁止
- フィールド追加は許可（後方互換）
- event.action の追加は原則禁止（3種に限定）。追加が必要な場合は設計変更として扱う
